# 数据链路层

## 第一讲

### 术语

* 结点：主机和路由器
* 链路：连接相邻节点的通信信道
  * 有线链路
  * 无线链路
  * 局域网
* 链路层数据分组：帧，封装网络层数据报
* **数据链路层**负责通过一条链路从一个节点向另一个物理链路直接相连的相邻节点发送数据报

### 链路层服务

* 组帧
  * 封装数据报构成数据帧，加首部和尾部
  * 帧同步 ：通过加字符或者特殊字符串来区分
* 链路接入
  * 如果是共享介质，需要解决信道接入
  * 帧首部的MAC地址，用于识别帧的源和目的
    * 不同IP地址
* 相邻节点间的可靠交付
  * 在低误码率的有线链路上很少采用(如光纤，某些双绞线)
  * 无线链路：误码率高，需要可靠交付
* 流量控制
  * 协调相邻的发送结点和接送结点的发送速率
* 差错检测
  * 信号衰减和噪声会引起差错
  * 接收端检测到差错：
    * 通知发送端重传或者直接丢掉帧
* 差错纠正
  * 接收端直接纠正比特差错
* 全双工或者半双工通信控制
  * 全双工：链路两端结点同时双向传输
  * 半双工：链路两端结点交替双向传输

### 链路层的具体实现

* 每个主机或路由器接口
* 链路层在“适配器”（即网络接口卡-NIC）中实现或者在一个芯片上实现
  * 以太网网卡，802.11网卡：以太网芯片组
  * 实现链路层和物理层
* 链接主机的系统总线
* 由硬件、软件与固件组成
* 工作：
  * 发送端
    * 将数据封装成帧
    * 增加差错检测比特，实现可靠数据传输和流量控制
  * 接收端
    * 检测差错，实现可靠数据传输和流量控制等
    * 提取数据报，交付上层协议实体

## 第二讲

### 差错编码

* 基本原理
  * D->D**R**,其中为差错检测与纠正比特(冗余比特)
  ![基本原理图](../imgs/1.png)
  * **差错编码不能保证100%可靠**：即使R = R'也不一定没错
* 差错编码可以分**检错码**与**纠错码**
* 对于检错码，如果编码集的汉明距离ds=r+1,则该差错编码可以检测r位的差错
  * 汉明距离：两个码字之间对应比特位不同的个数
  * **编码集的汉明距离！！！！！！**
* 对于纠错码，如果编码集的汉明距离ds = 2r+1,则该差错编码可以纠正r位的差错
  * 纠错码的基本原则：将一个错误码字纠错到离他距离最近的一个有效码字

### 常见校验码

* 奇偶校验码
  * 检测奇数位差错
* 二维奇偶校验
  * 检测奇数位差错、部分偶数位差错
* Internet检验和(Checksum)
  * 发送端
    * 初始CheckSum全为0
    * 数据划分16位的序列
    * 求和(sum)：补码求和(最高位进的1返回低位继续加)
    * 校验和：sum的反码
    * 放入分组(UDP,TCP)的检验和字段
  * 接收端
    * 与发送端相同算法计算
    * 计算得到的Checksun
      * 如果加上得到的Checksum则得到0就没错，否则有错
      * 如果不加上得到的Checksum则与原来得到的对比即可
* 循环冗余校验码(CRC)
  * 检错能力更强大的差错编码
  * 将数据比特，**D**,视为一个二进制数
  * 选择一个r+1的比特模式（生成比特模式）,**G**
  * 目标：选择r位的CRC比特,**R**,满足
    * <D,R>刚好可以被G整除(模2)
    * 接受端检错：利用G除<D,R>，余式全为0，无错；否则，有错！
    * 可以检测所有突发长度小于r+1位差错
  * 广泛用于实际网络(以太网，802.11 WIFI,ATM)
    * **怎么找R?**
        >期望：D*2^r(左移r位) XOR R = nG
            D*2^r = nG XOR R
        相当于：如果利用G去除D*2^r,则余式即为R
    * ![过程](../imgs/2.png)
    
## 第四讲
### 多路访问控制(MAC)协议
* 两类“链路”：
    * 点对点链路
        * 拨号接入的PPP
        * 以太网交换机与主机间的点对点链路
    * 广播链路(共享介质)
        * 早期的总线以太网
        * HFC的上行链路
        * 802.11无线局域网
* 单一共享广播信道
* 两个或者两个以上结点同时传输：干扰
    * **冲突**
        * 结点同时接受到两个或者多个信号 -->**接收失败！**
    >**于是需要多路访问控制协议**
* 采用分布式算法决定结点如何共享信道，即决策结点何时可以传输数据
* 必须基于信道本书，通信信道共享协调信息！
    * 无带外信道用于协调

### 理想MAC协议
* 给定：速率为R bps的广播信道
* 期望：
    * 当只有一个结点希望传输数据时，它可以以速率R发送
    * 当有M个结点期望发送数据时，每个结点平均发送数据的平均速率是R/M
    * 完全分散控制：
        * 无需特定结点协调
        * 无需时钟、时隙同步
    * 简单

### MAC协议分类
三大类
* 信道划分MAC协议
    * 多路复用技术
    * TDMA、FDMA、CDMA、WDMA等
* 随机访问MAC访问(局域网中常见)
    * 信道不划分，允许冲突
    * 采用冲突"恢复"机制
* 轮转(taking turns)MAC协议
    * 结点轮流使用信道

### 信道划分协议
以TDMA为例子
* “周期性”接入信道
* 每个站点在每个周期，占用固定长度的时隙
* 未用时隙空闲
* 例如：6-站点LAN, 1,3,4传输分组，2,5,6空闲
**FDMA类似**

## 第五讲
### 随机访问MAC协议
* 当结点要发送分组是：
    * 利用信道全部数据速率R发送分组
    * 没有事先的结点间协调
* 两个或者多个结点同时传输： -->“冲突”
* 随机访问MAC协议需要定义：
    * 如何检测冲突
    * 如何从冲突中恢复(eg.通过延迟重传)
* 典型的随机访问MAC协议：
    * 时隙ALOHA
    * ALOHA
    * CSMA、CSMA/CD、CSMA/CA

### 时隙ALOHA协议
* **假定**
    * 所有帧大小相同
    * 时间被划分为等长的时隙(每个时隙可以传输1个帧)
    * 结点只能在时隙开始时刻发送帧
    * 结点间时钟同步
    * 如果2个或者2个以上结点在同一时隙发送帧，结点即检测到冲突
* **运行**
    * 当结点有新的帧时，在当下一个时隙发送
        * 如果无冲突：该结点可以在下一个时隙继续发送新的帧
        * 如果冲突：该结点在下一个时隙以概率p重传该帧，直至成功
* 优点
    * 单个结点活动时，可以连续以信道全部速率传输数据
    * 高度分散化：只需同步时隙
    * 简单
* 缺点：
    * 冲突，浪费时隙
    * 空闲时隙(冲突后所有都概率不发送了)
    * 结点也许能以远小于分组传输时间检测到冲突
* **效率：**长期运行时，成功发送帧的时隙所占比例(有很多结点，有很多帧待发送)
    * 假设：N个结点有很多帧待传输，每个结点在每个时隙均以概率p发送数据
    * 对于给定的一个结点，在一个时隙讲帧发送成功的概率=p(1-p)^(N-1)
    * 对于任意一个结点成功发送帧的概率=Np(1-p)^(N-1)
    * 最大效率：求得使Np(1-p)^(N-1)最大的p*
    * 对于很多结点，当N趋于无穷时的极限，可得**最大效率=1/e=0.37**

### ALOHA协议
* 非时隙(纯)Aloha:更加简单，无需同步
* 当由新的帧产生时
    * 立即发送
* 冲突可能性增大：
    * 在t0时刻发送帧，会与在[t0-1,t0+1](有些教材叫易损时间区)，期间其他结点发送的帧同步
    ![图](../imgs/3.png)
* 效率：![效率](../imgs/4.png)

## 第六讲
### CSMA协议（载波监听多路访问协议）
* 发送帧之前，监听信道(载波)
    * 信道空闲：发送完整帧
    * 信道忙：推迟发送
        * 1-坚持CSMA
        * 非坚持CSMA
        * P-坚持CSMA
* **冲突仍然发生：**
    * 信号传播延迟
    ![冲突](../imgs/5.png)
* 继续发送冲突帧：浪费信道资源

### 带有冲突检测的CSMA协议(CSMA/CD,CSMA with Collision Delection)（以太网应用）
* 短时间内可以检测到冲突
* 冲突后传输终止，减少信道浪费
* 冲突检测
    * 有线局域网易于实现：测量信号强度，比较发射信号与接收信号
    * 无线局域网很难实现：收信号强度淹没在本地发射信号强度下
**边听边发，不发不听**
![冲突检测](../imgs/6.png)
* 对数据帧的最小长度计算
![最小帧长度计算](../imgs/7.png)
* 效率：
![效率](../imgs/8.png)

## 第七讲
### 轮转访问MAC协议
* 信道划分MAC协议：
    * 信道负载重时，共享信道**效率高**，且公平
    * 网络负载轻时，共享信道**效率低!**
* 随机访问MAC协议：
    * 网络负载轻时，共享信道**效率高**，单个结点可以利用信道的全部带宽
    * 网络负载重时，产生冲突开销
* **轮转访问MAC协议：**综合两者优点
    * 轮询(polling):
        * 主结点轮流"邀请"从属结点发送数据
        * 典型应用：“哑”从属设备
        * 问题：
            * 轮询开销
            * 等待延时(前面结点不发送数据，但是它得等到主结点依次轮询到它才行)
            * 单点故障(实际会考虑到)
    * 令牌传递(token passing):
        * 控制令牌依次从一个结点传递到下一个结点.(**结点构成环形网络**)
        * 令牌：特殊帧
        * 问题：
            * 令牌开销
            * 等待延迟
            * 单点故障(实际会考虑到)

## 第八讲
### MAC地址
* 32位IP地址
    * 接口的网络层地址
    * 用于标识网络层(第三层)分组，支持分组转发
* MAC地址(或称LAN地址,物理地址，以太网地址)：
    * 作用：用于局域网内标识一个帧从哪个接口发出，到达哪个物理相连的其他接口
    * 48位MAC地址(用于大部分LANs),**固化在网卡的ROM中**，有时也可以软件设置
* 重要性：**局域网内的每块网卡都有一个唯一的MAC地址**
* MAC地址由IEEE统一管理与分配
* 网卡生产厂商购买MAC地址空间(前24比特)
* 类比：
    * MAC地址:身份证号
    * IP地址：邮政地址
* MAC地址是“平面”地址：-->可“携带”
    * 可以从一个LAN移到另一个LAN
* IP地址是层次地址：-->不可"携带"
    * IP地址依赖于结点连接到哪个子网

### ARP:地址解析协议
* **问题:**在同一个LAN中，如何在已知目的接口的IP地址前提下确定其MAC地址？
